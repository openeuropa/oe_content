<?php

/**
 * @file
 * The OpenEuropa Content module.
 */

declare(strict_types = 1);

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\link\LinkItemInterface;
use Drupal\Core\Url;

/**
 * Implements hook_entity_base_field_info().
 */
function oe_content_entity_base_field_info(EntityTypeInterface $entity_type) {
  $fields = [];

  if ($entity_type->id() !== 'node') {
    return $fields;
  }

  $fields['oe_content_short_title'] = BaseFieldDefinition::create('string')
    ->setLabel(t('Short title'))
    ->setRequired(FALSE)
    ->setTranslatable(TRUE)
    ->setRevisionable(TRUE)
    ->setSetting('max_length', 255)
    ->setDisplayOptions('form', [
      'type' => 'string_textfield',
      'weight' => 0,
    ])
    ->setDisplayConfigurable('view', TRUE)
    ->setDisplayConfigurable('form', TRUE);

  $fields['oe_content_navigation_title'] = BaseFieldDefinition::create('string')
    ->setLabel(t('Navigation title'))
    ->setRequired(FALSE)
    ->setTranslatable(TRUE)
    ->setRevisionable(TRUE)
    ->setSetting('max_length', 255)
    ->setDisplayOptions('form', [
      'type' => 'string_textfield',
      'weight' => 0,
    ])
    ->setDisplayConfigurable('view', TRUE)
    ->setDisplayConfigurable('form', TRUE);

  $fields['oe_content_content_owner'] = BaseFieldDefinition::create('skos_concept_entity_reference')
    ->setLabel(t('Content owner'))
    ->setRequired(TRUE)
    ->setTranslatable(FALSE)
    ->setRevisionable(TRUE)
    ->setCardinality(FieldStorageDefinitionInterface::CARDINALITY_UNLIMITED)
    ->setSettings([
      'target_type' => 'skos_concept',
      'handler_settings' => [
        'concept_schemes' => [
          'http://publications.europa.eu/resource/authority/corporate-body',
        ],
        'field' => [
          'field_name' => 'oe_content_content_owner',
          'entity_type' => 'node',
          'bundle' => NULL,
          'concept_schemes' => [
            'http://publications.europa.eu/resource/authority/corporate-body',
          ],
        ],
      ],
      'default_value' => 0,
    ])
    ->setDisplayOptions('form', [
      'type' => 'skos_concept_entity_reference_autocomplete',
      'weight' => 0,
    ])
    ->setDisplayConfigurable('view', TRUE)
    ->setDisplayConfigurable('form', TRUE);

  $fields['oe_content_legacy_link'] = BaseFieldDefinition::create('link')
    ->setLabel(t('Legacy link'))
    ->setRequired(FALSE)
    ->setTranslatable(TRUE)
    ->setRevisionable(TRUE)
    ->setSettings([
      'link_type' => LinkItemInterface::LINK_EXTERNAL,
      'title' => DRUPAL_DISABLED,
    ])
    ->setDisplayOptions('form', [
      'type' => 'link_default',
      'weight' => 0,
    ])
    ->setDisplayConfigurable('view', TRUE)
    ->setDisplayConfigurable('form', TRUE);

  return $fields;
}

/**
 * Implements hook_field_widget_form_alter().
 */
function oe_content_field_widget_form_alter(&$element, FormStateInterface $form_state, $context) {
  // We add an after build method so we can alter the Url of the help link.
  if ($element['#type'] == 'text_format') {
    $element['#after_build'][] = '_oe_content_alter_textarea_help';
  }
}

/**
 * After build callback to alter the Url of the help link on text areas.
 */
function _oe_content_alter_textarea_help($form_element, FormStateInterface $form_state) {
  if (isset($form_element['format'])) {
    $form_element['format']['help']['about']['#url'] = Url::fromRoute('filter.tips', ['filter_format' => $form_element['#format']]);
  }
  return $form_element;
}
